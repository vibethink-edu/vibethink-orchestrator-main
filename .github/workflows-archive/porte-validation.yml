name: ðŸš€ Porte Validation Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/apps/**'
      - 'src/components/**'
      - 'src/modules/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/apps/**'
      - 'src/components/**'
      - 'src/modules/**'
  workflow_dispatch:
    inputs:
      component_name:
        description: 'Nome del componente a validar'
        required: true
        type: string
      validation_level:
        description: 'Nivel de validaciÃ³n'
        required: true
        default: 'full'
        type: choice
        options:
        - quick
        - full
        - security-only

env:
  NODE_VERSION: "20"
  COMPONENT_NAME: ${{ github.event.inputs.component_name || 'auto-detect' }}

jobs:
  detect-changes:
    name: ðŸ” Detect Component Changes
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.detect.outputs.matrix }}
      has-changes: ${{ steps.detect.outputs.has-changes }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Detect changed components
      id: detect
      run: |
        if [ "${{ env.COMPONENT_NAME }}" != "auto-detect" ]; then
          echo "matrix=[\"${{ env.COMPONENT_NAME }}\"]" >> $GITHUB_OUTPUT
          echo "has-changes=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Detect changes in apps and components
        changed_files=$(git diff --name-only HEAD~1 HEAD || git diff --name-only ${{ github.event.before }} ${{ github.sha }})
        
        components=()
        
        # Check for changes in src/apps
        for file in $changed_files; do
          if [[ $file == src/apps/* ]]; then
            app_name=$(echo $file | cut -d'/' -f3)
            if [[ ! " ${components[@]} " =~ " ${app_name} " ]]; then
              components+=("$app_name")
            fi
          fi
        done
        
        # Check for changes in src/modules (analysis directories)
        for file in $changed_files; do
          if [[ $file == src/modules/*-analysis/* ]]; then
            module_name=$(echo $file | cut -d'/' -f3 | sed 's/-analysis$//')
            if [[ ! " ${components[@]} " =~ " ${module_name} " ]]; then
              components+=("$module_name")
            fi
          fi
        done
        
        if [ ${#components[@]} -eq 0 ]; then
          echo "has-changes=false" >> $GITHUB_OUTPUT
          echo "matrix=[]" >> $GITHUB_OUTPUT
        else
          matrix_json=$(printf '%s\n' "${components[@]}" | jq -R . | jq -s .)
          echo "matrix=$matrix_json" >> $GITHUB_OUTPUT
          echo "has-changes=true" >> $GITHUB_OUTPUT
          echo "Detected changes in components: ${components[@]}"
        fi

  validate-porte:
    name: âœ… Validate Porte Component
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    
    strategy:
      matrix:
        component: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install root dependencies
      run: npm ci

    - name: Check if component app exists
      id: check-app
      run: |
        if [ -d "src/apps/${{ matrix.component }}" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "app-path=src/apps/${{ matrix.component }}" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Install component dependencies
      if: steps.check-app.outputs.exists == 'true'
      run: |
        cd src/apps/${{ matrix.component }}
        npm ci

    - name: Run TypeScript validation
      if: steps.check-app.outputs.exists == 'true'
      run: |
        cd src/apps/${{ matrix.component }}
        npm run type-check

    - name: Run linting
      if: steps.check-app.outputs.exists == 'true'
      run: |
        cd src/apps/${{ matrix.component }}
        npm run lint

    - name: Run unit tests
      if: steps.check-app.outputs.exists == 'true'
      run: |
        cd src/apps/${{ matrix.component }}
        npm run test -- --coverage --reporter=json --reporter=json-summary

    - name: Upload test results
      if: steps.check-app.outputs.exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.component }}
        path: |
          src/apps/${{ matrix.component }}/coverage/
          src/apps/${{ matrix.component }}/test-results.json

    - name: Run full migration validation
      if: steps.check-app.outputs.exists == 'true'
      run: |
        node scripts/migration-validator.js ${{ matrix.component }}

    - name: Upload validation report
      if: always() && steps.check-app.outputs.exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: validation-report-${{ matrix.component }}
        path: src/apps/${{ matrix.component }}/validation-report.json

    - name: Performance test
      if: steps.check-app.outputs.exists == 'true' && github.event.inputs.validation_level != 'quick'
      run: |
        cd src/apps/${{ matrix.component }}
        npm run build
        # Check bundle size
        du -sh dist/ > bundle-size.txt
        cat bundle-size.txt

    - name: Upload performance results
      if: steps.check-app.outputs.exists == 'true' && github.event.inputs.validation_level != 'quick'
      uses: actions/upload-artifact@v4
      with:
        name: performance-results-${{ matrix.component }}
        path: src/apps/${{ matrix.component }}/bundle-size.txt

  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    
    strategy:
      matrix:
        component: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Check if component app exists
      id: check-app
      run: |
        if [ -d "src/apps/${{ matrix.component }}" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Install dependencies
      if: steps.check-app.outputs.exists == 'true'
      run: |
        cd src/apps/${{ matrix.component }}
        npm ci

    - name: Run security audit
      if: steps.check-app.outputs.exists == 'true'
      run: |
        cd src/apps/${{ matrix.component }}
        npm audit --audit-level high --json > security-audit.json || true

    - name: Check for high/critical vulnerabilities
      if: steps.check-app.outputs.exists == 'true'
      run: |
        cd src/apps/${{ matrix.component }}
        if [ -f security-audit.json ]; then
          high_vulns=$(cat security-audit.json | jq -r '.vulnerabilities | to_entries[] | select(.value.severity == "high" or .value.severity == "critical") | .key' | wc -l)
          if [ $high_vulns -gt 0 ]; then
            echo "âŒ Found $high_vulns high/critical vulnerabilities"
            cat security-audit.json | jq -r '.vulnerabilities | to_entries[] | select(.value.severity == "high" or .value.severity == "critical")'
            exit 1
          else
            echo "âœ… No high/critical vulnerabilities found"
          fi
        fi

    - name: Upload security results
      if: always() && steps.check-app.outputs.exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: security-results-${{ matrix.component }}
        path: src/apps/${{ matrix.component }}/security-audit.json

  integration-test:
    name: ðŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: [detect-changes, validate-porte]
    if: needs.detect-changes.outputs.has-changes == 'true' && github.event.inputs.validation_level == 'full'
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    strategy:
      matrix:
        component: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Check if component app exists
      id: check-app
      run: |
        if [ -d "src/apps/${{ matrix.component }}" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Install dependencies
      if: steps.check-app.outputs.exists == 'true'
      run: |
        npm ci
        cd src/apps/${{ matrix.component }}
        npm ci

    - name: Setup test database
      if: steps.check-app.outputs.exists == 'true'
      run: |
        # Setup test database schema
        PGPASSWORD=postgres psql -h localhost -U postgres -d test_db -c "CREATE SCHEMA IF NOT EXISTS public;"
        
    - name: Run integration tests
      if: steps.check-app.outputs.exists == 'true'
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        SUPABASE_URL: http://localhost:54321
        SUPABASE_ANON_KEY: test-anon-key
      run: |
        cd src/apps/${{ matrix.component }}
        npm run test -- --run --reporter=verbose test/**/*.integration.test.*

    - name: Upload integration test results
      if: always() && steps.check-app.outputs.exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: integration-results-${{ matrix.component }}
        path: src/apps/${{ matrix.component }}/test-results/integration/

  upstream-check:
    name: ðŸ“¡ Upstream Tracking
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run upstream tracking
      run: |
        node scripts/upstream-tracker.js --check-all

    - name: Upload upstream report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: upstream-tracking-report
        path: docs/PROJECT/08_TOOLCHAIN_AND_SETUP/upstream-tracking-report.json

  generate-report:
    name: ðŸ“Š Generate Validation Report
    runs-on: ubuntu-latest
    needs: [validate-porte, security-scan, integration-test, upstream-check]
    if: always() && needs.detect-changes.outputs.has-changes == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Generate comprehensive report
      run: |
        mkdir -p validation-reports
        
        # Create summary report
        cat > validation-reports/pipeline-summary.md << 'EOF'
        # ðŸ“‹ Porte Validation Pipeline Report
        
        **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        **Workflow**: ${{ github.workflow }}
        **Run ID**: ${{ github.run_id }}
        **Commit**: ${{ github.sha }}
        
        ## ðŸŽ¯ Components Validated
        
        EOF
        
        # Add component-specific results
        for component in $(echo '${{ needs.detect-changes.outputs.matrix }}' | jq -r '.[]'); do
          echo "### ðŸ“¦ $component" >> validation-reports/pipeline-summary.md
          
          if [ -f "validation-report-${component}/validation-report.json" ]; then
            status=$(cat "validation-report-${component}/validation-report.json" | jq -r '.summary.overall_status')
            passed=$(cat "validation-report-${component}/validation-report.json" | jq -r '.summary.passed')
            failed=$(cat "validation-report-${component}/validation-report.json" | jq -r '.summary.failed')
            warnings=$(cat "validation-report-${component}/validation-report.json" | jq -r '.summary.warnings')
            
            echo "- **Status**: $status" >> validation-reports/pipeline-summary.md
            echo "- **Passed**: $passed" >> validation-reports/pipeline-summary.md
            echo "- **Failed**: $failed" >> validation-reports/pipeline-summary.md
            echo "- **Warnings**: $warnings" >> validation-reports/pipeline-summary.md
          else
            echo "- **Status**: COMPONENT_NOT_FOUND" >> validation-reports/pipeline-summary.md
          fi
          
          echo "" >> validation-reports/pipeline-summary.md
        done
        
        # Add security summary
        echo "## ðŸ”’ Security Summary" >> validation-reports/pipeline-summary.md
        echo "" >> validation-reports/pipeline-summary.md
        
        for component in $(echo '${{ needs.detect-changes.outputs.matrix }}' | jq -r '.[]'); do
          if [ -f "security-results-${component}/security-audit.json" ]; then
            high_vulns=$(cat "security-results-${component}/security-audit.json" | jq -r '.vulnerabilities | to_entries[] | select(.value.severity == "high" or .value.severity == "critical") | .key' | wc -l)
            echo "- **$component**: $high_vulns high/critical vulnerabilities" >> validation-reports/pipeline-summary.md
          fi
        done
        
        echo "" >> validation-reports/pipeline-summary.md
        echo "---" >> validation-reports/pipeline-summary.md
        echo "*Generated by AI Pair Orchestrator Pro - VTK v4.6 Porte Framework*" >> validation-reports/pipeline-summary.md

    - name: Upload comprehensive report
      uses: actions/upload-artifact@v4
      with:
        name: pipeline-validation-report
        path: validation-reports/

    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('validation-reports/pipeline-summary.md')) {
            const report = fs.readFileSync('validation-reports/pipeline-summary.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
          }

  deployment-ready:
    name: ðŸš€ Deployment Readiness Check
    runs-on: ubuntu-latest
    needs: [validate-porte, security-scan, integration-test]
    if: always() && needs.detect-changes.outputs.has-changes == 'true'
    
    steps:
    - name: Check validation results
      run: |
        validate_result="${{ needs.validate-porte.result }}"
        security_result="${{ needs.security-scan.result }}"
        integration_result="${{ needs.integration-test.result }}"
        
        echo "Validation: $validate_result"
        echo "Security: $security_result"
        echo "Integration: $integration_result"
        
        if [[ "$validate_result" == "success" && "$security_result" == "success" ]]; then
          if [[ "$integration_result" == "success" || "$integration_result" == "skipped" ]]; then
            echo "âœ… All validations passed - Ready for deployment"
            echo "DEPLOYMENT_READY=true" >> $GITHUB_ENV
          else
            echo "âŒ Integration tests failed - Not ready for deployment"
            echo "DEPLOYMENT_READY=false" >> $GITHUB_ENV
            exit 1
          fi
        else
          echo "âŒ Validation or security checks failed - Not ready for deployment"
          echo "DEPLOYMENT_READY=false" >> $GITHUB_ENV
          exit 1
        fi

    - name: Update deployment status
      if: env.DEPLOYMENT_READY == 'true'
      run: |
        echo "ðŸŽ‰ Components are ready for deployment to staging environment"
