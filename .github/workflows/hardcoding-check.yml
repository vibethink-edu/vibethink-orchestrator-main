name: Hardcoding Detection CI/CD

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  hardcoding-check:
    name: Hardcoding Detection
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version-file: '.nvmrc'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run hardcoding detection
      id: hardcoding-check
      run: |
        echo "üîç Ejecutando detecci√≥n de hardcoding..."
        npm run check-hardcoding-all
        
        # Guardar el resultado para usar en comentarios
        if [ $? -eq 0 ]; then
          echo "result=success" >> $GITHUB_OUTPUT
        else
          echo "result=failure" >> $GITHUB_OUTPUT
        fi
        
    - name: Upload hardcoding report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: hardcoding-report
        path: hardcoding-report.json
        retention-days: 30
        
    - name: Comment PR with violations
      if: github.event_name == 'pull_request' && steps.hardcoding-check.outputs.result == 'failure'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          try {
            const report = JSON.parse(fs.readFileSync('hardcoding-report.json', 'utf8'));
            
            let commentBody = `## üö® Violaciones de Hardcoding Detectadas
            
            **Este PR no puede ser mergeado hasta que se corrijan las violaciones cr√≠ticas de hardcoding.**
            
            ### üìä Resumen
            - üö® **Cr√≠ticas**: ${report.summary.critical} (bloquean merge)
            - ‚ö†Ô∏è **Altas**: ${report.summary.high}
            - üìù **Medias**: ${report.summary.medium}
            - üí° **Bajas**: ${report.summary.low}
            
            ### üö® Violaciones Cr√≠ticas (Deben corregirse)
            `;
            
            if (report.violations.critical.length > 0) {
              report.violations.critical.forEach((v, index) => {
                commentBody += `
                **${index + 1}. ${v.file}:${v.line}**
                - Tipo: ${v.type}
                - Mensaje: ${v.message}
                - C√≥digo: \`${v.code}\`
                - Sugerencia: ${v.suggestion}
                `;
              });
            } else {
              commentBody += `No hay violaciones cr√≠ticas.`;
            }
            
            commentBody += `
            ### ‚ö†Ô∏è Violaciones Altas (Considerar correcci√≥n)
            `;
            
            if (report.violations.high.length > 0) {
              report.violations.high.slice(0, 5).forEach((v, index) => {
                commentBody += `
                **${index + 1}. ${v.file}:${v.line}**
                - Tipo: ${v.type}
                - Mensaje: ${v.message}
                `;
              });
              
              if (report.violations.high.length > 5) {
                commentBody += `
                *... y ${report.violations.high.length - 5} m√°s*
                `;
              }
            } else {
              commentBody += `No hay violaciones altas.`;
            }
            
            commentBody += `
            ### üí° Recomendaciones
            - Usa variables de entorno para configuraciones
            - Parametriza por pa√≠s/industria
            - Evita entidades espec√≠ficas hardcodeadas
            - Documenta cualquier excepci√≥n temporal
            
            ### üîß C√≥mo corregir
            1. Lee el [Sistema de Prevenci√≥n de Hardcoding](https://github.com/your-repo/docs/architecture/HARDCODING_PREVENTION_SYSTEM.md)
            2. Aplica las correcciones sugeridas
            3. Ejecuta \`npm run check-hardcoding\` localmente
            4. Actualiza este PR
            
            ---
            *Detectado autom√°ticamente por AI Pair Hardcoding Detector*
            `;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
            
          } catch (error) {
            console.error('Error al procesar el reporte:', error);
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚ö†Ô∏è Error en Detecci√≥n de Hardcoding
              
              No se pudo procesar el reporte de hardcoding. Por favor, ejecuta \`npm run check-hardcoding\` localmente y corrige cualquier violaci√≥n antes de continuar.
              
              ---
              *Error: ${error.message}*
              `
            });
          }
          
    - name: Comment PR with success
      if: github.event_name == 'pull_request' && steps.hardcoding-check.outputs.result == 'success'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          try {
            const report = JSON.parse(fs.readFileSync('hardcoding-report.json', 'utf8'));
            
            let commentBody = `## ‚úÖ Verificaci√≥n de Hardcoding Completada
            
            **¬°Excelente! No se detectaron violaciones cr√≠ticas de hardcoding.**
            
            ### üìä Resumen
            - ‚úÖ **Cr√≠ticas**: ${report.summary.critical}
            - ‚ö†Ô∏è **Altas**: ${report.summary.high}
            - üìù **Medias**: ${report.summary.medium}
            - üí° **Bajas**: ${report.summary.low}
            `;
            
            if (report.summary.high > 0 || report.summary.medium > 0) {
              commentBody += `
              ### üí° Sugerencias de Mejora
              `;
              
              if (report.summary.high > 0) {
                commentBody += `- Considera corregir las ${report.summary.high} violaciones altas para mejorar la calidad del c√≥digo
                `;
              }
              
              if (report.summary.medium > 0) {
                commentBody += `- Considera parametrizar las ${report.summary.medium} violaciones medias para mayor universalidad
                `;
              }
            } else {
              commentBody += `
              ### üéâ ¬°Perfecto!
              No se detectaron violaciones que requieran atenci√≥n inmediata.
              `;
            }
            
            commentBody += `
            ---
            *Verificado autom√°ticamente por AI Pair Hardcoding Detector*
            `;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
            
          } catch (error) {
            console.error('Error al procesar el reporte de √©xito:', error);
          }
          
    - name: Fail on critical violations
      if: steps.hardcoding-check.outputs.result == 'failure'
      run: |
        echo "‚ùå VIOLACIONES CR√çTICAS DETECTADAS"
        echo "üö® Este PR no puede ser mergeado hasta que se corrijan las violaciones cr√≠ticas de hardcoding."
        echo "üìã Revisa los comentarios del PR para m√°s detalles."
        exit 1
        
    - name: Notify architect on critical violations
      if: steps.hardcoding-check.outputs.result == 'failure'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          try {
            const report = JSON.parse(fs.readFileSync('hardcoding-report.json', 'utf8'));
            
            if (report.summary.critical > 0) {
              // Crear issue para notificar al arquitecto
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üö® Violaciones Cr√≠ticas de Hardcoding - PR #${context.issue.number}`,
                body: `## üö® Violaciones Cr√≠ticas de Hardcoding Detectadas
                
                **PR**: #${context.issue.number}
                **Autor**: @${context.payload.pull_request.user.login}
                **Archivo**: ${context.payload.pull_request.head.ref}
                
                ### üìä Resumen
                - üö® **Cr√≠ticas**: ${report.summary.critical}
                - ‚ö†Ô∏è **Altas**: ${report.summary.high}
                - üìù **Medias**: ${report.summary.medium}
                - üí° **Bajas**: ${report.summary.low}
                
                ### üö® Violaciones Cr√≠ticas
                ${report.violations.critical.map((v, index) => `
                **${index + 1}. ${v.file}:${v.line}**
                - Tipo: ${v.type}
                - Mensaje: ${v.message}
                - C√≥digo: \`${v.code}\`
                `).join('')}
                
                ### üîß Acci√≥n Requerida
                - [ ] Revisar violaciones cr√≠ticas
                - [ ] Guiar al desarrollador en las correcciones
                - [ ] Validar que las correcciones siguen los principios de AI Pair
                - [ ] Aprobar el PR una vez corregido
                
                ---
                *Notificaci√≥n autom√°tica del Sistema de Prevenci√≥n de Hardcoding*
                `,
                labels: ['hardcoding', 'critical', 'architect-review'],
                assignees: ['marcelo'] // Reemplazar con el username del arquitecto
              });
            }
            
          } catch (error) {
            console.error('Error al notificar al arquitecto:', error);
          }
          
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: hardcoding-check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version-file: '.nvmrc'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run security audit
      run: npm audit --audit-level moderate
      
    - name: Run Snyk security scan
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high 
