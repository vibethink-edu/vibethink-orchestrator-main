name: ğŸ† VTK v4.6 Complete Testing Framework

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Tipo de testing a ejecutar'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - unit
        - integration
        - e2e
        - performance
        - compliance

env:
  NODE_VERSION: '18'
  CACHE_DEPENDENCY_PATH: package-lock.json

jobs:
  # ğŸ” VTK Compliance Validation
  VTK-compliance:
    name: ğŸ” VTK v4.6 Compliance
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
          cache-dependency-path: ${{ env.CACHE_DEPENDENCY_PATH }}

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ† VTK v4.6 Validation
        run: node scripts/validate-simple.js

      - name: ğŸ“Š Upload VTK compliance report
        uses: actions/upload-artifact@v4
        with:
          name: VTK-compliance-report
          path: |
            scripts/methodology/validation-*.json
            scripts/methodology/VTK-*.json

  # ğŸ§ª Unit & Integration Tests
  unit-integration-tests:
    name: ğŸ§ª Unit & Integration Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'unit' || github.event.inputs.test_type == 'integration' || github.event.inputs.test_type == null
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
          cache-dependency-path: ${{ env.CACHE_DEPENDENCY_PATH }}

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§ª Unit Tests (Vitest)
        run: npm run test:unit
        env:
          NODE_ENV: test

      - name: ğŸ”— Integration Tests
        run: npm run test:integration
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/testdb

      - name: ğŸ“Š Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: unit-integration-coverage
          path: |
            coverage/
            test-results/

  # ğŸŒ E2E Tests (Playwright)
  e2e-tests:
    name: ğŸŒ E2E Tests (Playwright)
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'e2e' || github.event.inputs.test_type == null
    
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
          cache-dependency-path: ${{ env.CACHE_DEPENDENCY_PATH }}

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ­ Install Playwright
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: ğŸ—ï¸ Build application
        run: npm run build

      - name: ğŸŒ Run E2E tests (${{ matrix.browser }})
        run: npx playwright test --project=${{ matrix.browser }}
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: ğŸ“¸ Upload E2E screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-${{ matrix.browser }}-results
          path: |
            test-results/
            playwright-report/

  # ğŸ§ª API Tests (Postman/Newman)
  api-tests:
    name: ğŸ§ª API Tests (Postman/Newman)
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'integration' || github.event.inputs.test_type == null
    needs: [unit-integration-tests]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§ª Install Newman
        run: npm install -g newman

      - name: ğŸ§ª Run API Tests (Development)
        run: |
          newman run docs/PROJECT/04_TESTING/postman/AI-Pair-Orchestrator-Pro.postman_collection.json \
            --environment docs/PROJECT/04_TESTING/postman/environments/development.json \
            --reporters cli,json,htmlextra \
            --reporter-json-export newman-results.json \
            --reporter-htmlextra-export newman-report.html
        env:
          SUPABASE_ANON_KEY_DEV: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          DEV_TEST_EMAIL: ${{ secrets.DEV_TEST_EMAIL }}
          DEV_TEST_PASSWORD: ${{ secrets.DEV_TEST_PASSWORD }}

      - name: ğŸ“Š Upload API test results
        uses: actions/upload-artifact@v4
        with:
          name: newman-api-test-results
          path: |
            newman-results.json
            newman-report.html

  # ğŸ“Š Performance Tests (k6)
  performance-tests:
    name: ğŸ“Š Performance Tests (k6)
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'performance' || github.event.inputs.test_type == null
    needs: [unit-integration-tests]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: ğŸ“Š Run Load Tests
        run: k6 run src/tests/performance/load-test.js --out json=k6-load-results.json
        env:
          BASE_URL: ${{ secrets.STAGING_URL || 'http://localhost:5173' }}

      - name: ğŸ” Run Security Performance Tests
        run: k6 run src/tests/security/security-test.js --out json=k6-security-results.json
        env:
          BASE_URL: ${{ secrets.STAGING_URL || 'http://localhost:5173' }}

      - name: ğŸ“Š Upload performance test results
        uses: actions/upload-artifact@v4
        with:
          name: k6-performance-results
          path: |
            k6-load-results.json
            k6-security-results.json

  # ğŸ“ˆ Testing Summary Report
  testing-summary:
    name: ğŸ“ˆ Testing Summary Report
    runs-on: ubuntu-latest
    needs: [VTK-compliance, unit-integration-tests, e2e-tests, api-tests, performance-tests]
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: ğŸ“Š Download all test artifacts
        uses: actions/download-artifact@v4
        with:
          path: test-artifacts/

      - name: ğŸ“ˆ Generate Testing Summary Report
        run: |
          echo "# ğŸ† VTK v4.6 Testing Framework Results" > TESTING_REPORT.md
          echo "" >> TESTING_REPORT.md
          echo "**Date**: $(date)" >> TESTING_REPORT.md
          echo "**Branch**: ${{ github.ref_name }}" >> TESTING_REPORT.md
          echo "**Commit**: ${{ github.sha }}" >> TESTING_REPORT.md
          echo "" >> TESTING_REPORT.md
          
          # VTK Compliance
          echo "## ğŸ” VTK v4.6 Compliance" >> TESTING_REPORT.md
          if [ "${{ needs.VTK-compliance.result }}" == "success" ]; then
            echo "âœ… **PASSED** - VTK v4.6 Compliance" >> TESTING_REPORT.md
          else
            echo "âŒ **FAILED** - VTK v4.6 Compliance" >> TESTING_REPORT.md
          fi
          echo "" >> TESTING_REPORT.md
          
          # Unit & Integration Tests
          echo "## ğŸ§ª Unit & Integration Tests" >> TESTING_REPORT.md
          if [ "${{ needs.unit-integration-tests.result }}" == "success" ]; then
            echo "âœ… **PASSED** - Unit & Integration Tests" >> TESTING_REPORT.md
          else
            echo "âŒ **FAILED** - Unit & Integration Tests" >> TESTING_REPORT.md
          fi
          echo "" >> TESTING_REPORT.md
          
          # E2E Tests
          echo "## ğŸŒ E2E Tests (Playwright)" >> TESTING_REPORT.md
          if [ "${{ needs.e2e-tests.result }}" == "success" ]; then
            echo "âœ… **PASSED** - E2E Tests (Cross-browser)" >> TESTING_REPORT.md
          else
            echo "âŒ **FAILED** - E2E Tests (Cross-browser)" >> TESTING_REPORT.md
          fi
          echo "" >> TESTING_REPORT.md
          
          # API Tests
          echo "## ğŸ§ª API Tests (Newman)" >> TESTING_REPORT.md
          if [ "${{ needs.api-tests.result }}" == "success" ]; then
            echo "âœ… **PASSED** - API Tests (Postman/Newman)" >> TESTING_REPORT.md
          else
            echo "âŒ **FAILED** - API Tests (Postman/Newman)" >> TESTING_REPORT.md
          fi
          echo "" >> TESTING_REPORT.md
          
          # Performance Tests
          echo "## ğŸ“Š Performance Tests (k6)" >> TESTING_REPORT.md
          if [ "${{ needs.performance-tests.result }}" == "success" ]; then
            echo "âœ… **PASSED** - Performance Tests (k6)" >> TESTING_REPORT.md
          else
            echo "âŒ **FAILED** - Performance Tests (k6)" >> TESTING_REPORT.md
          fi
          echo "" >> TESTING_REPORT.md
          
          # Overall Status
          echo "## ğŸ¯ Overall Status" >> TESTING_REPORT.md
          if [[ "${{ needs.VTK-compliance.result }}" == "success" && 
                "${{ needs.unit-integration-tests.result }}" == "success" && 
                "${{ needs.e2e-tests.result }}" == "success" && 
                "${{ needs.api-tests.result }}" == "success" && 
                "${{ needs.performance-tests.result }}" == "success" ]]; then
            echo "ğŸ† **ALL TESTS PASSED** - VTK v4.6 Framework Complete" >> TESTING_REPORT.md
          else
            echo "âš ï¸ **SOME TESTS FAILED** - Review failed jobs above" >> TESTING_REPORT.md
          fi

      - name: ğŸ“„ Upload Testing Summary Report
        uses: actions/upload-artifact@v4
        with:
          name: VTK-testing-summary-report
          path: TESTING_REPORT.md

      - name: ğŸ”” Add PR Comment (if PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('TESTING_REPORT.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  # ğŸš€ Deploy (only on main branch success)
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [VTK-compliance, unit-integration-tests, e2e-tests, api-tests, performance-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && needs.VTK-compliance.result == 'success' && needs.unit-integration-tests.result == 'success' && needs.e2e-tests.result == 'success' && needs.api-tests.result == 'success' && needs.performance-tests.result == 'success'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to Production
        run: |
          echo "ğŸ‰ All VTK v4.6 tests passed!"
          echo "ğŸš€ Deploying to production..."
          # Add actual deployment commands here
          
      - name: ğŸ”” Success Notification
        run: |
          echo "âœ… VTK v4.6 Framework: All tests passed!"
          echo "ğŸš€ Deployment completed successfully!"
          echo "ğŸ† Project is VTK v4.6 compliant and production ready!"

