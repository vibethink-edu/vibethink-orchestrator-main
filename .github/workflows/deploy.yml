name: ğŸš€ Production Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  NODE_VERSION: '18'
  CACHE_DEPENDENCY_PATH: package-lock.json

jobs:
  # ğŸ” Pre-deployment Validation
  validate:
    name: ğŸ” Pre-deployment Validation
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
          cache-dependency-path: ${{ env.CACHE_DEPENDENCY_PATH }}

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Security audit
        run: npm audit --audit-level moderate

      - name: ğŸ§ª Run critical tests
        run: npm run test:ci

      - name: ğŸ—ï¸ Build validation
        run: npm run build

      - name: ğŸ“Š Bundle analysis
        run: npm run analyze

  # ğŸš€ Staging Deployment
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'staging'
    environment: staging
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
          cache-dependency-path: ${{ env.CACHE_DEPENDENCY_PATH }}

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build for staging
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.STAGING_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.STAGING_SUPABASE_ANON_KEY }}
          VITE_ENVIRONMENT: staging

      - name: ğŸ³ Build Docker image
        run: |
          docker build -t vibethink-orchestrator:staging .
          docker tag vibethink-orchestrator:staging ${{ secrets.DOCKER_REGISTRY }}/vibethink-orchestrator:staging

      - name: ğŸ” Login to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸš€ Push Docker image
        run: docker push ${{ secrets.DOCKER_REGISTRY }}/vibethink-orchestrator:staging

      - name: ğŸš€ Deploy to staging
        run: |
          echo "ğŸš€ Deploying to staging environment..."
          # Kubernetes deployment
          kubectl set image deployment/vibethink-orchestrator-staging \
            app=${{ secrets.DOCKER_REGISTRY }}/vibethink-orchestrator:staging
          kubectl rollout status deployment/vibethink-orchestrator-staging

      - name: ğŸ§ª Run smoke tests
        run: |
          echo "ğŸ§ª Running smoke tests on staging..."
          npm run test:smoke -- --base-url=${{ secrets.STAGING_URL }}

      - name: ğŸ“Š Performance test
        run: |
          echo "ğŸ“Š Running performance tests..."
          npm run test:performance -- --url=${{ secrets.STAGING_URL }}

  # ğŸš€ Production Deployment
  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [validate, deploy-staging]
    if: github.ref == 'refs/heads/main' && github.event.inputs.environment == 'production'
    environment: production
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
          cache-dependency-path: ${{ env.CACHE_DEPENDENCY_PATH }}

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build for production
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.PRODUCTION_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.PRODUCTION_SUPABASE_ANON_KEY }}
          VITE_ENVIRONMENT: production

      - name: ğŸ³ Build Docker image
        run: |
          docker build -t vibethink-orchestrator:production .
          docker tag vibethink-orchestrator:production ${{ secrets.DOCKER_REGISTRY }}/vibethink-orchestrator:production

      - name: ğŸ” Login to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸš€ Push Docker image
        run: docker push ${{ secrets.DOCKER_REGISTRY }}/vibethink-orchestrator:production

      - name: ğŸš€ Deploy to production
        run: |
          echo "ğŸš€ Deploying to production environment..."
          # Blue-green deployment
          kubectl set image deployment/vibethink-orchestrator-blue \
            app=${{ secrets.DOCKER_REGISTRY }}/vibethink-orchestrator:production
          kubectl rollout status deployment/vibethink-orchestrator-blue
          
          # Switch traffic
          kubectl patch service vibethink-orchestrator-service \
            -p '{"spec":{"selector":{"deployment":"vibethink-orchestrator-blue"}}}'

      - name: ğŸ§ª Run production tests
        run: |
          echo "ğŸ§ª Running production tests..."
          npm run test:smoke -- --base-url=${{ secrets.PRODUCTION_URL }}

      - name: ğŸ“Š Monitor deployment
        run: |
          echo "ğŸ“Š Monitoring deployment health..."
          npm run monitor:deployment -- --url=${{ secrets.PRODUCTION_URL }}

  # ğŸ“Š Post-deployment Monitoring
  monitor:
    name: ğŸ“Š Post-deployment Monitoring
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
          cache-dependency-path: ${{ env.CACHE_DEPENDENCY_PATH }}

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ“Š Health check
        run: |
          echo "ğŸ“Š Running health checks..."
          npm run health:check

      - name: ğŸ“ˆ Performance monitoring
        run: |
          echo "ğŸ“ˆ Monitoring performance metrics..."
          npm run monitor:performance

      - name: ğŸ”” Send notifications
        run: |
          echo "ğŸ”” Sending deployment notifications..."
          npm run notify:deployment

  # ğŸ”„ Rollback (if needed)
  rollback:
    name: ğŸ”„ Rollback Deployment
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: failure()
    
    steps:
      - name: ğŸ”„ Rollback to previous version
        run: |
          echo "ğŸ”„ Rolling back deployment..."
          kubectl rollout undo deployment/vibethink-orchestrator-staging
          kubectl rollout undo deployment/vibethink-orchestrator-production

      - name: ğŸ”” Send rollback notification
        run: |
          echo "ğŸ”” Sending rollback notification..."
          npm run notify:rollback 
