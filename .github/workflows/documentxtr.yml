name: DocumentXTR - Automated Documentation & Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # Permite ejecuci√≥n manual

jobs:
  documentxtr:
    name: DocumentXTR Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run DocumentXTR
        run: node scripts/DocumentXTR.js
        
      - name: Upload DocumentXTR artifacts
        uses: actions/upload-artifact@v4
        with:
          name: documentxtr-reports
          path: |
            docs/xtr-report.json
            docs/xtr-report.md
            docs/methodology/
            docs/processes/
            docs/impact-analysis/
            docs/retrospective/
          retention-days: 30
          
      - name: Comment PR with DocumentXTR summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'docs/xtr-report.json';
            
            if (fs.existsSync(reportPath)) {
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              
              const comment = `## üìä DocumentXTR Analysis Report
              
              **Command:** ${report.command}
              **Version:** ${report.version}
              **Timestamp:** ${report.timestamp}
              
              ### üìà Metrics
              - **Components Documented:** ${report.metrics.componentsDocumented}
              - **Modules Documented:** ${report.metrics.modulesDocumented}
              - **APIs Documented:** ${report.metrics.apisDocumented}
              - **FAQs Generated:** ${report.metrics.faqsGenerated}
              - **Evidence Created:** ${report.metrics.evidenceCreated}
              - **Compliance Score:** ${report.metrics.complianceScore}%
              
              ### üìã Summary
              - ‚úÖ Documentation Generated: ${report.summary.documentationGenerated ? 'Yes' : 'No'}
              - ‚úÖ Methodology Documented: ${report.summary.methodologyDocumented ? 'Yes' : 'No'}
              - ‚úÖ Processes Documented: ${report.summary.processesDocumented ? 'Yes' : 'No'}
              - ‚úÖ Impact Analyzed: ${report.summary.impactAnalyzed ? 'Yes' : 'No'}
              - ‚úÖ Retrospective Validated: ${report.summary.retrospectiveValidated ? 'Yes' : 'No'}
              
              ### üéØ Recommendations
              ${report.recommendations.map(rec => `- ${rec}`).join('\n')}
              
              ---
              *Generated automatically by DocumentXTR*`;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
            
      - name: Create DocumentXTR summary issue
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'docs/xtr-report.json';
            
            if (fs.existsSync(reportPath)) {
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              
              const title = `üìä DocumentXTR Analysis - ${new Date().toISOString().split('T')[0]}`;
              const body = `## DocumentXTR Analysis Report
              
              **Command:** ${report.command}
              **Version:** ${report.version}
              **Timestamp:** ${report.timestamp}
              
              ### üìà Metrics
              - **Components Documented:** ${report.metrics.componentsDocumented}
              - **Modules Documented:** ${report.metrics.modulesDocumented}
              - **APIs Documented:** ${report.metrics.apisDocumented}
              - **FAQs Generated:** ${report.metrics.faqsGenerated}
              - **Evidence Created:** ${report.metrics.evidenceCreated}
              - **Compliance Score:** ${report.metrics.complianceScore}%
              
              ### üìã Summary
              - ‚úÖ Documentation Generated: ${report.summary.documentationGenerated ? 'Yes' : 'No'}
              - ‚úÖ Methodology Documented: ${report.summary.methodologyDocumented ? 'Yes' : 'No'}
              - ‚úÖ Processes Documented: ${report.summary.processesDocumented ? 'Yes' : 'No'}
              - ‚úÖ Impact Analyzed: ${report.summary.impactAnalyzed ? 'Yes' : 'No'}
              - ‚úÖ Retrospective Validated: ${report.summary.retrospectiveValidated ? 'Yes' : 'No'}
              
              ### üéØ Recommendations
              ${report.recommendations.map(rec => `- ${rec}`).join('\n')}
              
              ### üìÅ Generated Files
              **Documentation:** ${report.files.documentation.length} files
              **Methodology:** ${report.files.methodology.length} files
              **Processes:** ${report.files.processes.length} files
              **Impact Analysis:** ${report.files.impact.length} files
              **Retrospective:** ${report.files.retrospective.length} files
              
              ---
              *Generated automatically by DocumentXTR*`;
              
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['documentxtr', 'automation', 'documentation']
              });
            }
            
      - name: Validate compliance score
        run: |
          if [ -f "docs/xtr-report.json" ]; then
            COMPLIANCE_SCORE=$(node -p "require('./docs/xtr-report.json').metrics.complianceScore")
            if [ "$COMPLIANCE_SCORE" -lt 90 ]; then
              echo "‚ùå Compliance score is below 90%: $COMPLIANCE_SCORE%"
              exit 1
            else
              echo "‚úÖ Compliance score is acceptable: $COMPLIANCE_SCORE%"
            fi
          else
            echo "‚ùå DocumentXTR report not found"
            exit 1
          fi
          
      - name: Notify team on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ‚ùå DocumentXTR Analysis Failed
            
            The automated documentation and analysis process failed. Please check the logs and ensure:
            
            1. All required files are present
            2. DocumentXTR script is working correctly
            3. Compliance score meets minimum requirements (90%)
            
            **Action Required:** Manual review and fix of documentation issues.
            
            ---
            *Generated automatically by DocumentXTR*`;
            
            if (context.eventName === 'pull_request') {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } 