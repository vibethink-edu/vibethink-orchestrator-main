name: ğŸš€ CI/CD Pipeline - AI Pair Orchestrator Pro

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'
  CACHE_DEPENDENCY_PATH: package-lock.json

jobs:
  # ğŸ” Code Quality & Security
  quality-check:
    name: ğŸ” Code Quality & Security
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: Guardrail - conflict markers
        run: |
          if grep -R -n -E "^[[:space:]]*(<<<<<<<|=======|>>>>>>>)" .; then
            echo "Conflict markers found."
            exit 1
          fi

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.CACHE_DEPENDENCY_PATH }}

      - name: Use npm 10.2.4
        run: npm install -g npm@10.2.4

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” ESLint check
        run: npm run lint

      - name: ğŸ¨ Prettier check
        run: npm run format:check

      - name: ğŸ” Security audit
        run: npm audit --audit-level moderate

      - name: ğŸ“Š TypeScript check
        run: npm run type-check

  # ğŸ§ª Unit & Integration Tests
  test:
    name: ğŸ§ª Unit & Integration Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.CACHE_DEPENDENCY_PATH }}

      - name: Use npm 10.2.4
        run: npm install -g npm@10.2.4

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run unit tests
        run: npm run test:unit
        env:
          VITE_SUPABASE_URL: http://localhost:54321
          VITE_SUPABASE_ANON_KEY: test-key

      - name: ğŸ”— Run integration tests
        run: npm run test:integration
        env:
          VITE_SUPABASE_URL: http://localhost:54321
          VITE_SUPABASE_ANON_KEY: test-key

      - name: ğŸ“Š Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          fail_ci_if_error: false

  # ğŸŒ E2E Tests
  e2e-test:
    name: ğŸŒ E2E Tests
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.CACHE_DEPENDENCY_PATH }}

      - name: Use npm 10.2.4
        run: npm install -g npm@10.2.4

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ­ Install Playwright
        run: npx playwright install --with-deps

      - name: ğŸ—ï¸ Build application
        run: npm run build

      - name: ğŸŒ Run E2E tests
        run: npm run test:e2e
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: ğŸ“¸ Upload E2E screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-screenshots
          path: test-results/

  # ğŸ—ï¸ Build & Deploy
  build-and-deploy:
    name: ğŸ—ï¸ Build & Deploy
    runs-on: ubuntu-latest
    needs: [quality-check, test, e2e-test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.CACHE_DEPENDENCY_PATH }}

      - name: Use npm 10.2.4
        run: npm install -g npm@10.2.4

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build for production
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: ğŸ“Š Analyze bundle size
        run: npm run analyze

      - name: ğŸš€ Deploy to staging
        run: |
          echo "ğŸš€ Deploying to staging environment..."
          # Add your deployment commands here
          
      - name: ğŸ§ª Run smoke tests
        run: |
          echo "ğŸ§ª Running smoke tests on staging..."
          # Add smoke test commands here

  # ğŸ“‹ API Documentation
  api-docs:
    name: ğŸ“‹ Update API Documentation
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.CACHE_DEPENDENCY_PATH }}

      - name: Use npm 10.2.4
        run: npm install -g npm@10.2.4

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ“‹ Generate API docs
        run: |
          echo "ğŸ“‹ Generating OpenAPI documentation..."
          # Add API doc generation commands here

      - name: ğŸŒ Deploy API docs
        run: |
          echo "ğŸŒ Deploying API documentation..."
          # Add API docs deployment commands here

  # ğŸ§ª Postman Collection Tests
  postman-tests:
    name: ğŸ§ª API Tests (Postman)
    runs-on: ubuntu-latest
    needs: [build-and-deploy]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§ª Install Newman
        run: npm install -g newman

      - name: ğŸ§ª Run Postman collection
        run: |
          newman run docs/postman/AI-Pair-Orchestrator-Pro.postman_collection.json \
            --environment docs/postman/environments/production.json \
            --reporters cli,json \
            --reporter-json-export postman-results.json
        env:
          SUPABASE_ANON_KEY_PROD: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          PROD_TEST_EMAIL: ${{ secrets.PROD_TEST_EMAIL }}
          PROD_TEST_PASSWORD: ${{ secrets.PROD_TEST_PASSWORD }}

      - name: ğŸ“Š Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: postman-test-results
          path: postman-results.json

  # ğŸ“Š Performance Testing
  performance-test:
    name: ğŸ“Š Performance Testing
    runs-on: ubuntu-latest
    needs: [build-and-deploy]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: ğŸ“Š Run performance tests
        run: k6 run tests/performance/load-test.js
        env:
          BASE_URL: ${{ secrets.STAGING_URL }}

      - name: ğŸ” Run security tests
        run: k6 run tests/security/security-test.js
        env:
          BASE_URL: ${{ secrets.STAGING_URL }}

  # ğŸ”” Notifications
  notify:
    name: ğŸ”” Notify Results
    runs-on: ubuntu-latest
    needs: [quality-check, test, e2e-test, build-and-deploy, postman-tests, performance-test]
    if: always()
    
    steps:
      - name: ğŸ”” Success notification
        if: ${{ contains(needs.*.result, 'success') && !contains(needs.*.result, 'failure') }}
        run: |
          echo "âœ… All CI/CD pipeline steps completed successfully!"
          echo "ğŸš€ Deployment ready for production!"

      - name: âš ï¸ Failure notification
        if: ${{ contains(needs.*.result, 'failure') }}
        run: |
          echo "âŒ CI/CD pipeline failed!"
          echo "ğŸ” Please check the failed jobs above."
          exit 1 

